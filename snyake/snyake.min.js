const SPEED=300,NUM_CATS=2,ROOM_WIDTH=19,ROOM_HEIGHT=19,NUM_CAT_FACES=8,meow=new Audio("media/meow.mp3");function range(n){return Array.from({length:n},(v,i)=>i)}function rand(n){return Math.floor(Math.random()*n)}function clone(o){return Array.isArray(o)?o.concat():Object.assign({},o)}function outOfBounds(pos,w,h){return pos.x<1||pos.x>w||(pos.y<1||pos.y>h)}function tick(db,key,n){return null!=(db=updateDB(db,key,n))&&redraw(db),db}function initDB(){let db={cats:{head:{pos:{x:1,y:1},dir:"E"},turns:[],ids:[1]},food:{pos:null}};return db.food.pos=newFoodPos(reifyCats(db.cats)),db}function updateDB(db,key,n){let head=db.cats.head,newDir=makeTurn(head.dir,key);return newDir!=head.dir&&(db.cats.turns.unshift(clone(head)),head.dir=newDir),head.pos=moveForward(head.pos,head.dir),db.cats.head=head,gameOver(db)?null:(samePos(head.pos,db.food.pos)&&(meow.play(),range(2).forEach(()=>{db.cats.ids.push(newCatId())}),db.food.pos=newFoodPos(reifyCats(db.cats))),db)}function gameOver(db){let pos=db.cats.head.pos;return!!outOfBounds(pos,19,19)||numLaps(reifyCats(db.cats),pos)>1}function newCatId(){return rand(8)+1}function newFoodPos(catLine){let pos={};for(;pos={x:rand(19)+1,y:rand(19)+1},numLaps(catLine,pos)>0;);return pos}function reifyCats(cats){let catLine=[],turns=clone(cats.turns),pos=cats.head.pos,dir=cats.head.dir,turn=turns.shift();return cats.ids.forEach(id=>{catLine.push({pos:pos,id:id}),void 0!==turn&&samePos(pos,turn.pos)&&(dir=turn.dir,turn=turns.shift()),pos=moveBackward(pos,dir)}),catLine}function makeTurn(dir,key){if(null==key)return dir;const lMap={N:"W",E:"N",S:"E",W:"S"},rMap={N:"E",E:"S",S:"W",W:"N"};return"L"==key?lMap[dir]:rMap[dir]}function numLaps(catLine,pos){return catLine.filter(c=>samePos(c.pos,pos)).length}function moveForward(pos,dir){return movePos(pos,dir,1)}function moveBackward(pos,dir){return movePos(pos,dir,-1)}function movePos(pos,dir,rev){const dMap={N:[0,-1],E:[1,0],S:[0,1],W:[-1,0]};let[dx,dy]=dMap[dir];return{x:pos.x+dx*rev,y:pos.y+dy*rev}}function samePos(pos1,pos2){return pos1.x==pos2.x&&pos1.y==pos2.y}function redraw(db){let room=theRoom();clearRoom(room),drawCats(room,db.cats),drawFood(room,db.food)}function drawCats(room,cats){let catLine;reifyCats(cats).forEach(c=>{joinToRoom(room,newCatElement(c.pos,c.id))})}function drawFood(room,food){joinToRoom(room,newFoodElement(food.pos))}function theRoom(){return document.querySelector("#room")}function clearRoom(room){room.innerHTML=""}function joinToRoom(room,e){room.appendChild(e)}function newCatElement(pos,id){let e=newElement(pos);return e.dataset.catId=id,e.classList.add("cat"),e}function newFoodElement(pos){let e=newElement(pos);return e.classList.add("food"),e}function newElement(pos){let e=document.createElement("div");return e.style.gridColumnStart=pos.x,e.style.gridRowStart=pos.y,e}meow.volume=.05,(()=>{let lastTickFrameTime=0,tickCount=0,db=initDB(),lastKey=null;const frame=frameTime=>{if(frameTime-lastTickFrameTime>300){lastTickFrameTime=frameTime,tickCount++;let next=tick(db,lastKey,tickCount);null==next&&(meow.play(),alert("Game over!\nScore: "+db.cats.ids.length),next=initDB()),db=next,lastKey=null}requestAnimationFrame(frame)};window.addEventListener("keydown",ev=>{null==lastKey&&(37!=ev.keyCode&&39!=ev.keyCode||(lastKey=37==ev.keyCode?"L":"R"))}),requestAnimationFrame(frame)})();